# 🔄 数据迁移指南

## 📋 概述

将LovePlanner从演示模式迁移为真实的双用户应用，只支持Cat🐱和Cow🐄两个预设用户。

## 🎯 迁移目标

### **从**：演示模式（localStorage）
- 临时数据存储
- 模拟用户认证
- 无持久化数据

### **到**：真实数据模式（Supabase）
- 真实数据库存储
- 预设用户认证
- 完整的数据持久化

## 🚀 迁移步骤

### 步骤1：运行数据库迁移脚本

#### **在Supabase SQL Editor中运行**：
```sql
-- 复制 scripts/migrate-users.sql 的全部内容
-- 粘贴到 Supabase SQL Editor 中
-- 点击 "Run" 执行
```

#### **迁移内容**：
- ✅ 创建Cat和Cow用户档案
- ✅ 建立情侣关系记录
- ✅ 添加示例任务数据
- ✅ 创建日历事件
- ✅ 设置积分系统
- ✅ 添加商店物品

### 步骤2：配置环境变量

确保 `.env.local` 包含真实的Supabase配置：
```env
NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...你的真实密钥...
```

### 步骤3：重启应用

```bash
# 停止当前服务器
# Ctrl+C

# 重新启动
npm run dev
```

## 👤 预设用户信息

### **Cat 用户 🐱**
- **ID**: `cat-user-id-fixed`
- **邮箱**: `cat@loveplanner.com`
- **密码**: `123456`
- **用户名**: `whimsical_cat`
- **显示名**: `Whimsical Cat`
- **角色**: `cat`
- **时区**: `Asia/Shanghai`
- **初始积分**: `150`

### **Cow 用户 🐄**
- **ID**: `cow-user-id-fixed`
- **邮箱**: `cow@loveplanner.com`
- **密码**: `123456`
- **用户名**: `whimsical_cow`
- **显示名**: `Whimsical Cow`
- **角色**: `cow`
- **时区**: `America/New_York`
- **初始积分**: `300`

## 📊 迁移的数据

### **用户数据**
- 2个预设用户档案
- 1个情侣关系记录
- 用户积分和时区设置

### **任务数据**
- 情人节惊喜（recruiting状态）
- 一起看星星（assigned状态）
- 每日咖啡时光（in-progress状态）
- 周末约会（completed状态）

### **日历事件**
- 恋爱纪念日（重复事件）
- 电影之夜（单次事件）
- 晨跑时光（个人事件）

### **积分系统**
- 初始积分奖励
- 任务完成奖励
- 完整的交易历史

### **商店物品**
- Cat的按摩服务
- Cow的爱心早餐
- 私人电影院体验
- 神秘礼物

## 🔧 技术变更

### **认证系统升级**
- ✅ 新的 `authService` 统一处理认证
- ✅ 支持演示模式和真实数据模式的无缝切换
- ✅ 预设用户的快速登录和手动登录
- ✅ 禁用注册功能（只支持2个预设用户）

### **状态管理改进**
- ✅ 更新 `useAuth` hook 支持预设用户
- ✅ 自定义事件系统保证状态同步
- ✅ 本地存储备份确保状态持久化

### **界面更新**
- ✅ 移除注册表单和注册功能
- ✅ 更新界面提示文本
- ✅ 优化快速登录体验

## 🧪 测试迁移结果

### **功能验证清单**

#### ✅ **认证功能**
- [ ] 快速登录Cat用户 → 立即进入主应用
- [ ] 快速登录Cow用户 → 立即进入主应用
- [ ] 手动登录 `cat@loveplanner.com` / `123456` → 成功
- [ ] 手动登录 `cow@loveplanner.com` / `123456` → 成功
- [ ] 错误密码 → 显示错误提示
- [ ] 登出功能 → 正确返回登录页面

#### ✅ **数据验证**
- [ ] 用户档案 → 显示真实的用户信息和积分
- [ ] 任务列表 → 显示预设的示例任务
- [ ] 日历事件 → 显示预设的事件数据
- [ ] 商店物品 → 显示预设的商店商品
- [ ] 积分历史 → 显示交易记录

#### ✅ **功能完整性**
- [ ] 创建新任务 → 保存到数据库
- [ ] 编辑用户档案 → 更新数据库
- [ ] 添加日历事件 → 持久化存储
- [ ] 任务状态变更 → 记录到数据库
- [ ] 积分交易 → 更新数据库记录

## 🎉 迁移完成标志

### **成功指标**
1. **登录页面显示**: "PRESET USERS: CAT 🐱 & COW 🐄"
2. **快速登录正常工作**: 点击用户头像立即进入应用
3. **数据持久化**: 刷新页面后数据不丢失
4. **真实积分**: 用户积分来自数据库而非固定值
5. **完整功能**: 所有CRUD操作都连接到Supabase

### **检查命令**
在浏览器控制台运行：
```javascript
// 检查是否为演示模式
console.log('演示模式:', !process.env.NEXT_PUBLIC_SUPABASE_URL || 
             process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://demo.supabase.co');

// 检查当前用户
console.log('当前用户:', localStorage.getItem('preset_user') || localStorage.getItem('demo_user'));
```

## 📈 后续优化建议

### **数据扩展**
- [ ] 添加更多示例任务和事件
- [ ] 创建更丰富的商店物品
- [ ] 设置任务分类和标签

### **功能增强**
- [ ] 实现任务提醒功能
- [ ] 添加成就系统
- [ ] 创建数据导出功能

### **性能优化**
- [ ] 实现数据缓存策略
- [ ] 添加离线支持
- [ ] 优化数据库查询

## 🆘 故障排除

### **常见问题**

**Q: 迁移后仍显示演示模式？**
A: 检查 `.env.local` 是否包含正确的Supabase URL

**Q: 快速登录不工作？**
A: 确保数据库迁移脚本已成功执行

**Q: 用户档案显示空白？**
A: 检查数据库中是否存在预设用户记录

**Q: 积分不正确？**
A: 检查 `point_transactions` 表和用户积分字段

## 🎊 恭喜！

迁移完成后，你的LovePlanner将成为一个真正的双用户爱情规划应用！

Cat🐱 和 Cow🐄 现在可以：
- 使用真实的数据库存储
- 享受完整的应用功能
- 拥有持久化的数据体验
- 共同规划甜蜜的未来！

开始你们的数字爱情之旅吧！💕✨
