# 🕐 测试时间控制器使用指南

## 🎯 功能概述

测试时间控制器允许你在开发环境中手动控制系统时间，方便测试时间相关的功能，特别是连续打卡任务。

## 🚀 快速开始

### 1. 启动应用
```bash
npm run dev
```

### 2. 查看时间控制器
在任务看板页面顶部会显示"🕐 测试时间控制器"组件（仅开发环境可见）

### 3. 基本操作

#### **查看当前状态**
- 🧪 测试模式：显示模拟时间
- ⏰ 真实模式：显示系统真实时间

#### **设置特定时间**
1. 选择日期（必填）
2. 选择时间（可选，默认12:00）
3. 点击"设置"按钮

#### **快速设置**
- **昨天**: 设置为昨天同一时间
- **明天**: 设置为明天同一时间  
- **上周**: 设置为一周前
- **下周**: 设置为一周后

#### **时间穿越**
- **-7天**: 时间后退7天
- **-1天**: 时间后退1天
- **+1天**: 时间前进1天
- **+7天**: 时间前进7天

#### **重置**
- **重置为真实时间**: 退出测试模式，恢复系统时间

## 🧪 测试连续打卡的完整流程

### 场景1: 测试每日连续打卡

#### **步骤1: 设置初始时间**
```
1. 设置时间为: 2025-01-01 10:00
2. 创建一个每日重复任务，要求连续7天
3. 领取任务并完成第一次打卡
```

#### **步骤2: 模拟连续打卡**
```
Day 1: 2025-01-01 - 打卡 ✅ (current_streak = 1)
Day 2: 点击"+1天" → 2025-01-02 - 打卡 ✅ (current_streak = 2)  
Day 3: 点击"+1天" → 2025-01-03 - 打卡 ✅ (current_streak = 3)
Day 4: 点击"+1天" → 2025-01-04 - 打卡 ✅ (current_streak = 4)
Day 5: 点击"+1天" → 2025-01-05 - 打卡 ✅ (current_streak = 5)
Day 6: 点击"+1天" → 2025-01-06 - 打卡 ✅ (current_streak = 6)
Day 7: 点击"+1天" → 2025-01-07 - 打卡 ✅ (current_streak = 7, 任务完成!)
```

#### **步骤3: 测试中断情况**
```
Day 8: 点击"+1天" → 2025-01-08 - 不打卡 ❌
Day 9: 点击"+1天" → 2025-01-09 - 打卡 ✅ (current_streak = 1, 重新开始)
```

### 场景2: 测试每周连续打卡

#### **步骤1: 设置初始时间**
```
1. 设置时间为: 2025-01-06 (周一)
2. 创建一个每周重复任务，要求连续4周
3. 领取任务并完成第一次打卡
```

#### **步骤2: 模拟连续打卡**
```
Week 1: 2025-01-06 - 打卡 ✅ (current_streak = 1)
Week 2: 点击"+7天" → 2025-01-13 - 打卡 ✅ (current_streak = 2)
Week 3: 点击"+7天" → 2025-01-20 - 打卡 ✅ (current_streak = 3)  
Week 4: 点击"+7天" → 2025-01-27 - 打卡 ✅ (current_streak = 4, 任务完成!)
```

### 场景3: 测试重复打卡防护

#### **验证同一周期不能重复打卡**
```
1. 设置时间为: 2025-01-01
2. 完成每日任务打卡 ✅
3. 再次尝试打卡 → 应该显示"已打卡"并禁用按钮 ❌
4. 点击"+1天" → 2025-01-02
5. 现在可以再次打卡 ✅
```

## 🖥️ 浏览器控制台命令

除了UI界面，你还可以在浏览器控制台中使用命令：

### **基本命令**
```javascript
// 设置特定时间
testTime.set("2025-01-01 10:00:00")

// 前进时间
testTime.advance(1)  // 前进1天
testTime.advance(7)  // 前进7天

// 后退时间  
testTime.goBack(1)   // 后退1天
testTime.goBack(7)   // 后退7天

// 查看状态
testTime.status()

// 快速设置
testTime.yesterday()  // 设置为昨天
testTime.tomorrow()   // 设置为明天
testTime.lastWeek()   // 设置为上周
testTime.nextWeek()   // 设置为下周

// 重置为真实时间
testTime.reset()
```

### **高级用法**
```javascript
// 批量测试连续7天打卡
for (let i = 0; i < 7; i++) {
  console.log(`第${i+1}天打卡`);
  // 手动点击打卡按钮
  testTime.advance(1);
}

// 测试跨月连续打卡
testTime.set("2024-12-30");  // 设置为月末
testTime.advance(1);         // 跨到下个月
testTime.advance(1);         // 继续下个月
```

## ⚠️ 注意事项

### **1. 仅开发环境可用**
- 生产环境不会显示时间控制器
- `process.env.NODE_ENV === 'development'` 时才启用

### **2. 页面刷新后保持状态**
- 测试时间会在页面刷新后保持
- 如果需要重置，请手动点击"重置为真实时间"

### **3. 影响范围**
测试时间会影响以下功能：
- ✅ 任务打卡时间验证
- ✅ 连续次数计算
- ✅ 任务过期检查
- ✅ 时间窗口限制
- ❌ 数据库时间戳（仍使用真实时间）

### **4. 数据一致性**
- 测试时间只影响业务逻辑计算
- 数据库的 `created_at`, `updated_at` 等字段仍使用真实时间
- 这是设计上的考虑，避免测试数据污染

## 🐛 故障排除

### **问题1: 时间控制器不显示**
- 确认是开发环境 (`npm run dev`)
- 检查浏览器控制台是否有错误

### **问题2: 打卡后连续次数不正确**
- 检查任务的 `completion_record` 数据格式
- 使用数据验证工具检查数据一致性
- 参考 `DATA_CONSISTENCY_CHECKER.md`

### **问题3: 时间设置后没有生效**
- 刷新页面重新加载组件
- 检查浏览器控制台的时间状态日志
- 使用 `testTime.status()` 确认当前状态

## 🎉 测试建议

### **全面测试清单**
- [ ] 每日连续打卡 (1-7天)
- [ ] 每周连续打卡 (1-4周)  
- [ ] 每月连续打卡 (1-3月)
- [ ] 中断后重新开始
- [ ] 重复打卡防护
- [ ] 跨日期边界 (月末、年末)
- [ ] 时间窗口限制
- [ ] 任务过期逻辑

### **性能测试**
- [ ] 大量历史记录的连续次数计算
- [ ] 时间频繁切换的性能影响
- [ ] 长时间测试模式的稳定性

这个测试时间控制器将大大提高你测试连续打卡功能的效率！🚀
